package cardgame;

import java.util.ArrayList;
import java.util.*;

// Cardgame
// author:
// date:
public class CardGame
{
    // properties
    Cards             fullPack;
    ArrayList<Player> players;
    ScoreCard         scoreCard;
    Cards[]           cardsOnTable;
    int               roundNo;
    int               turnOfPlayer;
    
    // constructors
    public CardGame( Player p1, Player p2, Player p3, Player p4)
    {
        players = new ArrayList<Player>();
        fullPack = new Cards( true);
        fullPack.shuffle();

        for ( int i = 0; i < 52; i++) {
            if ( i % 4 == 3) {
                p1.add(fullPack.getTopCard());
            }
            if ( i % 4 == 2) {
                p2.add(fullPack.getTopCard());
            }
            if ( i % 4 == 1) {
                p3.add(fullPack.getTopCard());
            }
            if ( i % 4 == 0) {
                p4.add(fullPack.getTopCard());
            }     
        }
        players.add( p1);
        players.add( p2);
        players.add( p3);
        players.add( p4);
        
        
        scoreCard = new ScoreCard( 4);
       
        cardsOnTable = new Cards[13]; // NULL POINTER!!! exception if you dont initialize its variables in a loop !!!
        for ( int i = 0; i < 13; i++) {
            cardsOnTable[i] = new Cards(false);
        }
        
        roundNo = 1;
        turnOfPlayer = 0;
    }
    
    public boolean playTurn( Player p, Card c)
    {
        if ( !isGameOver()) {
            if ( isTurnOf( p)) {
                if ( turnOfPlayer % 4 == 3) {
                    //roundNo++;
                }
                
                //c = p.playCard(); // card null dönüyor.
                
               // System.out.println(c);
                
                cardsOnTable[roundNo-1].addTopCard( c);
                
                if ( turnOfPlayer % 4 == 3 ) {
                    updateScores();
                    roundNo++;
                }
                turnOfPlayer++;
                
                return true;
            }
            
            return false;
        }
        
        return false;
    }
    
    public boolean isTurnOf( Player p)
    {
        int turnOfPlayer;
        
        turnOfPlayer = getTurnOfPlayerNo();
        
        // player 1
        if ( p == players.get(0) && turnOfPlayer == 0) {
            return true;
        }
        else if ( p == players.get(0) && turnOfPlayer != 0) {
            return false;
        }
        
        // player 2
        if ( p == players.get(1) && turnOfPlayer == 1) {
            return true;
        }
        else if ( p == players.get(1) && turnOfPlayer != 1) {
            return false;
        }
        
        // player 3
        if ( p == players.get(2) && turnOfPlayer == 2) {
            return true;
        }
        else if ( p == players.get(2) && turnOfPlayer != 2){
            return false;
        }
        
        // player 4
        if ( p == players.get(3) && turnOfPlayer == 3) {
            return true;
        }
        else {
            return false;
        }
    }
    
    public boolean isGameOver()
    {
        if ( roundNo >= 14) 
            return true;
        return false;
    }
    
    public int getScore( int playerNumber)
    {
        int scoreOfPlayer;
        
        scoreOfPlayer = scoreCard.getScore( playerNumber);
        
        return scoreOfPlayer;
    }
    
    public String getName( int playerNumber)
    {
        return players.get( playerNumber).getName();
    }
    
    public int getRoundNo()
    {
        return roundNo;
    }
    
    public int getTurnOfPlayerNo()
    {
        return turnOfPlayer % 4;
    }
    
    public Player[] getWinners()
    {
        Player[] winnerPlayers = null;
       
        if ( isGameOver()) {

            int[] winners;
            
            winners = scoreCard.getWinners();
            winnerPlayers = new Player[winners.length];
            
            for ( int i = 0; i < winners.length; i++) {
                winnerPlayers[i] = players.get( winners[i]);
            }
        }
        return winnerPlayers;
    }
    
    public String showScoreCard()
    {
        return scoreCard.toString();
    }
    
    private void updateScores() {
        int[] temp = new int [4];     
        int max1 = -1;
        int max2 = -1;
        int a = 0;
        int a3 = 0; // player 3
        int b = 0;
        int b1 = 0; // player 1
        
        Card temp1 = cardsOnTable[roundNo - 1].getTopCard();
        Card temp2 = cardsOnTable[roundNo - 1].getTopCard();
        
        if ( temp1.compareTo( temp2) > 0) {
            max1 = temp1.getFaceValue();
            a = 1; // player 4
        }
        else if ( temp1.compareTo ( temp2 ) == 0) {
            max1 = temp1.getFaceValue();
            a = 2; // player 3 and 4
        }
        else {
            max1 = temp2.getFaceValue();
            a3 = 1; // player 3
        }
        
        // compare last two cards
        temp1 = cardsOnTable[roundNo - 1].getTopCard();
        temp2 = cardsOnTable[roundNo - 1].getTopCard();
        if ( temp1.compareTo( temp2) > 0) {
            max2 = temp1.getFaceValue();
            b = 1; // player 2
        }
        else if ( temp1.compareTo ( temp2 ) == 0) {
            max2 = temp1.getFaceValue();
            b = 2; // player 1 and 2
        }
        else {
            max2 = temp2.getFaceValue();
            b1 = 1; // player 1
        }
        
        if ( max1 > max2) {
            if ( a == 1) {
                temp[3] = 1;
            }
            else if ( a == 2) {
                temp[2] = 1;
                temp[3] = 1;
            }
            else if ( a3 == 1) {
                temp[2] = 1;
            }
        }
        else if ( max1 == max2) {
            if ( a == 1 && b == 1) {
                temp[3] = 1;
                temp[1] = 1;
            }
            else if ( a == 1 && b == 2) {
                temp[3] = 1;
                temp[0] = 1;
                temp[1] = 1;
            }
            else if ( a == 1 && b1 == 1 ) {
                temp[3] = 1;
                temp[0] = 1;
            }
            else if ( a == 2 && b == 1) {
                temp[2] = 1;
                temp[3] = 1;
                temp[1] = 1;
            }
            else if ( a == 2 && b == 2) {
                temp[2] = 1;
                temp[3] = 1;
                temp[0] = 1;
                temp[1] = 1;
            }
            else if ( a == 2 && b1 == 1) {
                temp[2] = 1;
                temp[3] = 1;
                temp[0] = 1;
            }
            else if ( a3 == 1 && b == 1) {
                temp[2] = 1;
                temp[1] = 1;
            }
            else if ( a3 == 1 && b == 2) {
                temp[2] = 1;
                temp[1] = 1;
                temp[0] = 1;
            }
            else if ( a3 == 1 && b1 == 1) {
                temp[2] = 1;
                temp[0] = 1;
            }       
        }
        else {
            if ( b == 1) {
                temp[1] = 1;
            }
            else if ( b == 2) {
                temp[1] = 1;
                temp[0] = 1;
            }
            else if ( b1 == 1) {
                temp[0] = 1;
            }
        }
        
        
        
        // count how many same cards are on the table and
        // scoring system accordingly.
        int count = 0;
        for ( int i = 0; i < 4; i++) {
            if ( temp[i] == 1)
                count++;
        }
        if (count == 1) {
            for ( int i = 0; i < 4; i++) {
                if ( temp[i] == 1) {
                    scoreCard.update(i, 4);
                }
            }
        }
        else if ( count == 2) {
            for ( int i = 0; i < 4; i++) {
                if ( temp[i] == 1) {
                    scoreCard.update(i, 3);
                }
            }
        }
        else if ( count == 3) {
            for ( int i = 0; i < 4; i++) {
                if ( temp[i] == 1) {
                    scoreCard.update(i, 2);
                }
            }
        }
        else if ( count == 4) {
            for ( int i = 0; i < 4; i++) {
                if ( temp[i] == 1) {
                    scoreCard.update(i, 1);
                }
            }
        }
    }
    
    public String toString() {
        String result;
        Player[] arr;
        
        arr = getWinners();
        result = "Winner(s) " + "\n";
        
        if ( isGameOver()) {
            for ( int i = 0; i < arr.length; i++) {
                result = result + arr[i].getName() + "\n";
            }
        }
        else {
            result += "Game is NOT over yet!";
        }
        
        return result;   
    }
}